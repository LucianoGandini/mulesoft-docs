= REST API Examples
:keywords: rest, restful, raml, api, apis, examples, postgres

These examples of consuming REST APIs show you how to perform typical tasks:

* <<Simple Example: Consuming a REST API>>
+
Describes how to write an API that retrieves data from a publicly available REST API
+
* <<Extracting and Storing XML Data from a REST API>>
+
Covers retrieving data from a Yahoo REST API and inserting the data in a local Postgres database

== Simple Example: Consuming a REST API

This example queries the link:http://baconipsum.com/[Bacon Ipsum] REST API, which generates link:http://en.wikipedia.org/wiki/Lorem_ipsum[lorem ipsum] text. You don't have to use HTTPS or set up an account. Initally, First, you add and configure an HTTP listener and an HTTP requester:

image::rest-api-examples-ec226.png[rest-api-examples-ec226]

At this point, you can call the API and receive bacon ipsum text in the browser. Next, you add a File component to the example to save the output of the request for lorem ipsum text to a file on your file system.

*View the XML*

The following XML includes the configuration of the HTTP listener and HTTP requester:

[source, xml, linenums]
----
<mule xmlns:file="http://www.mulesoft.org/schema/mule/file" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
    xmlns:spring="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd">
    <http:listener-config name="HTTP_Listener_Configuration" host="0.0.0.0" port="8081" doc:name="HTTP Listener Configuration"/>
    <http:request-config name="HTTP_Request_Configuration" host="baconipsum.com"  doc:name="HTTP Request Configuration" basePath="api" port="80"/>
    <flow name="test2Flow1" >
        <http:listener config-ref="HTTP_Listener_Configuration" path="/" doc:name="HTTP" allowedMethods="GET"/>
        <http:request config-ref="HTTP_Request_Configuration" path="/" method="GET" doc:name="HTTP">
          <http:request-builder>
                <http:query-param paramName="type" value="#[message.inboundProperties.'http.query.params'.type]"/>
                <http:query-param paramName="sentences" value="#[message.inboundProperties.'http.query.params'.sentences]"/>
            </http:request-builder>
        </http:request>
    </flow>
</mule>
----

The first element, an link:/mule-user-guide/v/3.8/http-connector[HTTP listener], listens on localhost port 8081 (the default) for incoming GET requests. Calling the listener from a browser triggers the flow. Requests to the HTTP listener must take the form:

----
http://localhost:8081?<query>
----

The `<query>` part of the request consists of the parameters accepted by the REST API. When the HTTP listener receives the HTTP request, the `<query>` part of the URL is recorded as a set of inbound properties. The HTTP listener passes these properties to the next element in the flow, the HTTP request connector. This outbound connector is configured to query the remote REST API at http://baconipsum.com/api. The HTTP request connector uses  link:/mule-user-guide/v/3.8/mule-expression-language-mel[MEL expressions] to extract the query parameters from the message it received from the listener, and to construct the full URL for the remote API, including the query parameters.

For example, a local browser request `http://localhost:8081?type=meat-and-filler` results in this query: `http://baconipsum.com/api/?type=meat-and-filler`.

=== Configuring the HTTP Connectors

You need to specify how to call the API and what to return by configuring the HTTP Listener and HTTP requester.

==== HTTP Listener

[tabs]
------
[tab,title="Studio Visual Editor"]
....

In the Properties editor of the HTTP listener connector, set the *Path* to `/`:

image::rest-api-examples-bf47c.png[rest-api-examples-bf47c]

In *Connector Configuration*, click image:add.png[add], and set up the port and host:

image::rest-api-examples-876de.png[rest-api-examples-876de]

[cols=",",options="header"]
|===
|Parameter |Value
|*Name* |`HTTP_Listener_Configuration`
|*Host* |`localhost`
|*Port* |`8081`
|===
....
[tab,title="Standalone XML"]
....

Configure the HTTP connector as follows:

----
<http:listener config-ref="HTTP_Listener_Configuration" path="/" doc:name="HTTP"/>
----

[cols=",",options="header"]
|===
|Attribute |Value
|*http://docname[doc:name]* |`HTTP`
|*config-ref* |`HTTP_Listener_Configuration`
|*path* |/
|===

For this element to work, you must reference an abstract element called a *Connector Configuration*, which contains several of the high level necessary configuration properties. The **config-ref **attribute in the connector references this connector configuration element. You must now create an element outside the flow that matches the referenced name.

----
<http:listener-config name="HTTP_Listener_Configuration" host="localhost" port="8081" doc:name="HTTP Listener Configuration"/>
----

[cols=",",options="header"]
|===
|Attribute |Value
|*name* |`HTTP_Listener_Configuration`
|*host* |`localhost`
|*port* |`8081`
|*http://docname[doc:name]* |`HTTP Listener Configuration`
|===
....
------

==== HTTP Request Connector

[tabs]
------
[tab,title="Studio Visual Editor"]
....
. In *Connector Configuration*, click the image:add.png[add], and set up the *Host*, *Port*, and *Base Path*:
+
image::rest-api-examples-fc78a.png[rest-api-examples-fc78a]
+
[cols=",",options="header"]
|===
|Parameter |Value
|*Name* |`HTTP_Request_Connector`
|*Host* |`baconipsum.com`
|*Port* | `80`
|*Base Path* |`api`
|===
+
With this configuration, requests are sent to http://baconipsum.com/api.
+
. Click OK.
. In the properties editor, set up the path and method:
+
[cols=",",options="header"]
|===
|Parameter |Value
|*Path* |`/`
|*Method* |`GET`
|===
+
image::rest-api-examples-e5e5f.png[rest-api-examples-e5e5f]
+
. Add two parameters using *Add Parameter*. Accept the default type *query-param* for both. For the `value` field of each, write a mule expression that takes the specified value from the query parameters of the request that first reaches the HTTP Listener:
+
These values are transformed a into inbound properties by the time they reach the HTTP Request Connector.
+
image::rest-api-examples-ba00e.png[rest-api-examples-ba00e]
+
[cols=",",options="header"]
|===
|Parameter |Value
|*Type* |`query-param`
|*Name* |`type`
|*Value* |`#[message.inboundProperties.'http.query.params'.type]`
|===
+
[cols=",",options="header"]
|===
|Parameter |Value
|*Type* |`query-param`
|*Name* |`sentences`
|*Value* |`#[message.inboundProperties.'http.query.params'.sentences`]
|===
+
Configured in this way, the query params that reach the HTTP listener are forwarded unchanged to the baconipsum API.
....
[tab,title="Standalone XML"]
....
Configure the HTTP connector as follows:

[source, xml, linenums]
----
<http:request config-ref="HTTP_Request_Configuration" path="/" method="GET" doc:name="HTTP">
          <http:request-builder>
                <http:query-param paramName="type" value="#[message.inboundProperties.'http.query.params'.type]"/>
                <http:query-param paramName="sentences" value="#[message.inboundProperties.'http.query.params'.sentences]"/>
            </http:request-builder>
        </http:request>
----

[cols=",",options="header"]
|===
|Attribute |Value
|*http://docname[doc:name]* |`HTTP`
|*config-ref* |`HTTP_Request_Configuration`
|*path* |`/ `
|*method* |`GET`
|===

As you can see above, there are a series of child elements of the connector, these define two query parameters that take their values from inbound properties of the message. Enclosing the two elements that define these query parameters, is a `request-builder` element that is always necessary when adding parameters to a request.

[width="12%",cols=",",options="header"]
|===
|Parameter |Value
|*type* |`http:query-param`
|*paramName* |`type`
|*value* |`#[message.inboundProperties.'http.query.params'.type]`
|===

[cols=",",options="header",]
|===
|Parameter |Value
|*type* |`http:query-param`
|*paramName* |`sentences`
|*value* |`#[message.inboundProperties.'http.query.params'.sentences]`
|===

Configured in this way, the query params that reach the HTTP listener are forwarded unchanged to the baconipsum API.

For this element to work, you must reference an abstract element called a *Connector Configuration*, which contains several of the high level necessary configuration properties. The **config-ref **attribute in the connector references this connector configuration element. You must now create an element outside the flow that matches the referenced name.

[source, xml, linenums]
----
<http:request-config name="HTTP_Request_Configuration" host="baconipsum.com"  doc:name="HTTP Request Configuration" basePath="api"/>
----

[cols=",",options="header"]
|===
|Attribute |Value
|*name* |`HTTP_Request_Configuration`
|*host* |`baconipsum.com`
|*basePath* |`api`
|*http://docname[doc:name]* |`HTTP Request Configuration`
|===
....
------

=== File Outbound Endpoint

You can set this outbound endpoint to a directory and file name for storing the output.

[tabs]
------
[tab,title="Studio Visual Editor"]
....

The following example File connector properties and configuration sends the resulting text to the file `/tmp/output`.

. Drag a File connector to the flow.
+
image::rest-api-examples-2d8e6.png[rest-api-examples-2d8e6]
+
. In the properties editor, specify an actual path on your file system for the Path.
+
Mule runtime performs intermediate processes here, but does not write the output here.
+
. In *File Name/Pattern*, enter the name of an output file, for example `output`.
. In *Connector Configuration*, select *File* from the drop-down. lick
+
image::rest-api-examples-d0064.png[rest-api-examples-d0064]
+
. In *Connector Configuration*, click the image:add.png[add], and enter a path in *Write to Directory*. Enter `/tmp` for example.
+
image::rest-api-examples-479e3.png[rest-api-examples-479e3]

....
[tab,title="Standalone XML"]
....

----
<file:outbound-endpoint path="/tmp/" outputPattern="out.json"
----
....
------

=== Running this Example

. Run the example as a Mule application.
. To trigger the flow in this application, use a Web browser to hit the HTTP listener on localhost port 8081.
+
image::rest-api-examples-4c1b4.png[rest-api-examples-4c1b4]
+
The console logs a message that the response was written to the file you specified:
+
`INFO  2016-05-22 17:40:56,406 [[myproject].HTTP_Listener_Configuration.worker.01] org.mule.transport.file.FileConnector: Writing file to: /private/tmp/output`

Alternatively, you can use an HTTP client, such as the link:http://curl.haxx.se/download.html[curl] command-line utility to trigger the flow.

----
curl 'http://localhost:8081?type=meat-and-filler'
----

The link:http://baconipsum.com/api/[Bacon Ipsum API page] contains a list of parameters you can use, but you set up your connector to use only *type* and *sentences*.

----
type=meat-and-filler
sentences=<num>
----

`sentences` determines the number of sentences to return in the JSON response. It is optional, you may not include it in your requests.

The first parameter=value pair must be preceded by the `?` operator. To insert additional parameter=value pairs, use the `&` operator.

Example queries you can send to the HTTP listener on localhost port 8081 are:

----
http://localhost:8081?type=meat-and-filler
http://localhost:8081?sentences=2
http://localhost:8081?type=all-meat&sentences=3
----

The `type=meat-and-filler` example returns the output shown below.

----
["Doner ullamco ea non, porchetta incididunt brisket ball tip in chuck ex bresaola beef tongue.  Et aute ham hock kielbasa chuck fatback short ribs.  Kevin in reprehenderit est esse, ham bacon ut ball tip.  Laborum ut nulla ex irure t-bone flank, biltong cupidatat venison proident aliquip pork belly ham hock.  In consequat proident, cillum labore pariatur nisi.  Reprehenderit boudin beef ribs, frankfurter cillum enim pork loin consectetur kielbasa laboris.  Hamburger prosciutto nisi, jerky biltong ex pork chop venison.","Fatback tongue anim, irure ut ut cupidatat occaecat eiusmod ham hock laborum commodo.  Anim pig shank kielbasa, drumstick corned beef esse nostrud ham salami id laborum ribeye aute.  Duis pancetta sunt magna occaecat dolor leberkas, short loin meatloaf flank enim pastrami.  Prosciutto proident landjaeger deserunt tenderloin short loin.  Adipisicing aute in bresaola meatball, ut frankfurter pastrami shoulder porchetta turducken strip steak doner.  In filet mignon bresaola, sed deserunt pariatur eu mollit commodo shankle laborum.  Andouille aliqua jowl pork chop jerky sed consequat turkey voluptate bacon pastrami.","Ground round elit boudin reprehenderit.  Brisket shankle esse, leberkas veniam andouille rump proident drumstick.  Consequat sausage do ut prosciutto nostrud andouille tongue ullamco bacon est exercitation.  Do fugiat biltong est tempor short ribs reprehenderit adipisicing shoulder.  Tail venison shank incididunt, hamburger adipisicing voluptate corned beef fugiat sirloin fatback in tri-tip nisi ut.  Tail non excepteur, fugiat veniam corned beef dolore ex pig pork belly sint mollit chuck pork.","Pig hamburger dolore proident brisket landjaeger in boudin kielbasa ut elit.  Velit incididunt boudin qui.  Fatback anim adipisicing, pig jowl voluptate sirloin drumstick chicken esse.  Strip steak consequat tenderloin pastrami, ullamco brisket hamburger bacon beef adipisicing.  Tri-tip ham hock eu non et, flank dolore kevin.  Et duis frankfurter, ut ullamco do non quis boudin andouille aliqua venison ham.  Ut aliqua shoulder, aliquip pariatur bacon spare ribs irure.","Aliqua jerky frankfurter, swine ham in ground round sed qui laborum cow.  Sint turducken shank ut ea id.  Kevin dolore pig excepteur, anim ut magna.  Enim consequat short ribs corned beef ham hock nostrud fugiat chuck.  Tail spare ribs dolore boudin, andouille incididunt laboris occaecat strip steak.  Cow frankfurter capicola, landjaeger cupidatat porchetta ad ground round voluptate."]
----

To use any additional query parameter, you need to add it to your HTTP Connector first.

== Extracting and Storing XML Data from a REST API

This example application consumes XML data from an external REST API, extracts values from the XML, and inserts the values into an external Postgres database. The application uses the link:http://developer.yahoo.com/yql/console/[Yahoo! REST API] for financial services, which is free to use and does not require a user account. You call the API to retrieve financial quotes using the SQL-based link:http://developer.yahoo.com/yql/guide/running-chapt.html[Yahoo Query Language].

You query the Yahoo! REST API at http://query.yahooapis.com/v1/public/yql and specify the format using the `format=<format>` parameter, such as `format=XML`.

The API receives the reply and extracts some values such as stock name, date, and price. Finally, the API inserts the values into a table in an external Postgres database.

The application contains one flow:

image::rest-api-examples-5e84f.png[rest-api-examples-5e84f]

*View the XML*

[source, xml, linenums]
----
<mule xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
    xmlns:spring="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd">
    
    <db:generic-config name="Postgres" url="jdbc:postgresql://dbserver/stock" driverClassName="org.postgresql.Driver" doc:name="Generic Database Configuration"/>
    <db:template-query name="insert_into_current" doc:name="Template Query">
        <db:parameterized-query><![CDATA[INSERT INTO current("name", "date", "bookvalue") VALUES(:name,:date,:bookvalue);]]></db:parameterized-query>
        <db:in-param name="name" defaultValue="#[xpath3('//Name').text]"/>
        <db:in-param name="date" type="DATE" defaultValue="#[xpath3('//LastTradeDate').text]"/>
        <db:in-param name="bookvalue" defaultValue="#[xpath3('//BookValue').text])"/>
    </db:template-query>
        
    <http:listener-config name="HTTP_Listener_Configuration" host="localhost" port="8081" doc:name="HTTP Listener Configuration"/>
    <http:request-config name="HTTP_Request_Configuration" host="query.yahooapis.com" basePath="v1/public/yql" doc:name="HTTP Request Configuration"/>
    <flow name="financeapiFlow1" >
        <http:listener config-ref="HTTP_Listener_Configuration" path="/" doc:name="HTTP"/>
        <http:request config-ref="HTTP_Request_Configuration" path="/" method="GET" followRedirects="true" doc:name="HTTP">
            <http:request-builder>
                <http:query-param paramName="q" value="#[message.inboundProperties.'http.query.params'.q]"/>
                <http:query-param paramName="env" value="#[message.inboundProperties.'http.query.params'.env]"/>
                <http:query-param paramName="format" value="#[message.inboundProperties.'http.query.params'.format]"/>
            </http:request-builder>
        </http:request>
        <logger level="INFO" doc:name="Logger"/>
         
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <splitter expression="#[xpath3('//results')]" doc:name="Splitter"/>
        <db:insert config-ref="Postgres" doc:name="Database">
            <db:dynamic-query><![CDATA[INSERT INTO mystock("name", "date", "bookvalue") VALUES(#[xpath3('//Name').text], #[xpath3('//LastTradeDate').text], #[xpath3('//BookValue').text]);]]></db:dynamic-query>
        </db:insert> 
    </flow>
</mule>
----

The first element, an link:/mule-user-guide/v/3.8/http-connector[HTTP listener], listens on localhost port 8081 (the default) for incoming GET requests. Hitting the listener triggers the flow. Requests to the HTTP listener must take the form:

----
http://localhost:8081?<query>
----

The `<query>` part of the request consists of the parameters accepted by the REST API. When the HTTP listener receives the HTTP request, the `<query>` part of the URL becomes a set of inbound properties. The HTTP listener passes the message to the next element in the flow, the HTTP request connector. The HTTP request connector uses a set of  link:http://www.mulesoft.org/documentation/display/current/Mule+Expression+Language+MEL[MEL expressions] to extract the query parameters from the message, and to construct the full URL for the remote API, including the query parameters.

The application queries the following URL:

----
http://query.yahooapis.com/v1/public/yql?q=select * from yahoo.finance.quotes where symbol in ("BAC")%0A%09%09&env=http%3A%2F%2Fdatatables.org%2Falltables.env&format=XML
----

This query retrieves information for ticker symbol BAC, Bank of America, in XML format:

*View the XML returned by the REST API*

[source, xml, linenums]
----
<query xmlns:yahoo="http://www.yahooapis.com/v1/base.rng" yahoo:count="1" yahoo:created="2016-05-31T04:38:43Z" yahoo:lang="en-US">
  <results>
    <quote symbol="BAC">
        <Ask>14.87</Ask>
        <AverageDailyVolume>97748896</AverageDailyVolume>
        <Bid>14.86</Bid>
        <AskRealtime/>
        <BidRealtime/>
        <BookValue>23.12</BookValue>
        <Change_PercentChange>+0.18 - +1.22%</Change_PercentChange>
        <Change>+0.18</Change>
        <Commission/>
        <Currency>USD</Currency>
        <ChangeRealtime/>
        <AfterHoursChangeRealtime/>
        <DividendShare>0.20</DividendShare>
        <LastTradeDate>5/27/2016</LastTradeDate>
        <TradeDate/>
        <EarningsShare>1.27</EarningsShare>
        <ErrorIndicationreturnedforsymbolchangedinvalid/>
        <EPSEstimateCurrentYear>1.32</EPSEstimateCurrentYear>
        <EPSEstimateNextYear>1.58</EPSEstimateNextYear>
        <EPSEstimateNextQuarter>0.35</EPSEstimateNextQuarter>
        <DaysLow>14.69</DaysLow>
        <DaysHigh>14.88</DaysHigh>
        <YearLow>10.99</YearLow>
        <YearHigh>18.48</YearHigh>
        <HoldingsGainPercent/>
        <AnnualizedGain/>
        <HoldingsGain/>
        <HoldingsGainPercentRealtime/>
        <HoldingsGainRealtime/>
        <MoreInfo/>
        <OrderBookRealtime/>
        <MarketCapitalization>156.48B</MarketCapitalization>
        <MarketCapRealtime/>
        <EBITDA>0.00</EBITDA>
        <ChangeFromYearLow>3.89</ChangeFromYearLow>
        <PercentChangeFromYearLow>+35.40%</PercentChangeFromYearLow>
        <LastTradeRealtimeWithTime/>
        <ChangePercentRealtime/>
        <ChangeFromYearHigh>-3.60</ChangeFromYearHigh>
        <PercebtChangeFromYearHigh>-19.48%</PercebtChangeFromYearHigh>
        <LastTradeWithTime>4:01pm - <b>14.88</b></LastTradeWithTime>
        <LastTradePriceOnly>14.88</LastTradePriceOnly>
        <HighLimit/>
        <LowLimit/>
        <DaysRange>14.69 - 14.88</DaysRange>
        <DaysRangeRealtime/>
        <FiftydayMovingAverage>14.28</FiftydayMovingAverage>
        <TwoHundreddayMovingAverage>14.74</TwoHundreddayMovingAverage>
        <ChangeFromTwoHundreddayMovingAverage>0.14</ChangeFromTwoHundreddayMovingAverage>
        <PercentChangeFromTwoHundreddayMovingAverage>+0.98%</PercentChangeFromTwoHundreddayMovingAverage>
        <ChangeFromFiftydayMovingAverage>0.60</ChangeFromFiftydayMovingAverage>
        <PercentChangeFromFiftydayMovingAverage>+4.17%</PercentChangeFromFiftydayMovingAverage>
        <Name>Bank of America Corporation Com</Name>
        <Notes/>
        <Open>14.76</Open>
        <PreviousClose>14.70</PreviousClose>
        <PricePaid/>
        <ChangeinPercent>+1.22%</ChangeinPercent>
        <PriceSales>1.99</PriceSales>
        <PriceBook>0.64</PriceBook>
        <ExDividendDate>3/2/2016</ExDividendDate>
        <PERatio>11.70</PERatio>
        <DividendPayDate>3/25/2016</DividendPayDate>
        <PERatioRealtime/>
        <PEGRatio>1.52</PEGRatio>
        <PriceEPSEstimateCurrentYear>11.27</PriceEPSEstimateCurrentYear>
        <PriceEPSEstimateNextYear>9.42</PriceEPSEstimateNextYear>
        <Symbol>BAC</Symbol>
        <SharesOwned/>
        <ShortRatio>0.78</ShortRatio>
        <LastTradeTime>4:01pm</LastTradeTime>
        <TickerTrend/>
        <OneyrTargetPrice>17.37</OneyrTargetPrice>
        <Volume>62411281</Volume>
        <HoldingsValue/>
        <HoldingsValueRealtime/>
        <YearRange>10.99 - 18.48</YearRange>
        <DaysValueChange/>
        <DaysValueChangeRealtime/>
        <StockExchange>NYQ</StockExchange>
        <DividendYield>1.34</DividendYield>
        <PercentChange>+1.22%</PercentChange>
      </quote>
    </results>
</query>
<!--  total: 23  -->
<!--  main-6df7badb-1dfa-11e6-b981-e83935aedd3a  -->
----

The HTTP request connector passes the XML it receives from the API to a byte-array-to-string transformer, which converts the message payload to a string. Next, a link:/mule-user-guide/v/3.8/splitter-flow-control-reference[splitter] splits the message into parts. The splitter is configured to split the incoming message using the XML element `<results`> as delimiter. The REST API uses `<results>` to delimit the information for each stock symbol retrieved, as shown below.

[source, xml, linenums]
----
<results><quote symbol="BAC"><Ask/><AverageDailyVolume>107198000</AverageDailyVolume><Bid/>
...
</results>
----

If you use the API to query several stock symbols at once, the splitter splits the incoming XML into chunks corresponding to each queried symbol, then feeds each chunk to the next message processor.

To split the incoming XML, the splitter uses the link:/mule-user-guide/v/3.8/mule-expression-language-mel[Mule Expression Language] expression `#[xpath3('//results')]`, which contains the link:http://en.wikipedia.org/wiki/XPath[XPath] expression that actually retrieves the XML element `<results>`.

The last element in the flow, a link:/mule-user-guide/v/3.8/jdbc-connector[Database (JDBC)] connector, receives each XML chunk corresponding to each queried symbol. The JDBC connector is configured to run the following SQL query:

----
INSERT INTO mystock("name", "date", "bookvalue") VALUES(#[xpath3('//Name').text], #[xpath3('//LastTradeDate').text], #[xpath3('//BookValue').text]);
----

=== Configuring this Example

==== HTTP Listener

[tabs]
------
[tab,title="Studio Visual Editor"]
....
. In the Properties editor of the HTTP listener connector, set the *Path* to `/`:
+
image::rest-api-examples-2979f.png[rest-api-examples-2979f]
+
. In *Connector Configuration*, click the image:add.png[add], and set up the port and host:
+
image::rest-api-examples-c6d2d.png[rest-api-examples-c6d2d]
+
[cols=",",options="header"]
|===
|Parameter |Value
|*Name* |`HTTP_Listener_Configuration`
|*Host* |`localhost`
|*Port* |`8081`
|===
....
[tab,title="Standalone XML"]
....
Configure the HTTP connector as follows:

----
<http:listener config-ref="HTTP_Listener_Configuration" path="/" doc:name="HTTP"/>
----

[cols=",",options="header"]
|===
|Attribute |Value
|*http://docname[doc:name]* |`HTTP`
|*config-ref* |`HTTP_Listener_Configuration`
|*path* |/
|===

You reference an abstract element called a *Connector Configuration* that contains several of the high level necessary configuration properties. The **config-ref** attribute in the connector references this connector configuration element. You must now create an element outside the flow that matches the referenced name.

----
<http:listener-config name="HTTP_Listener_Configuration" host="localhost" port="8081" doc:name="HTTP Listener Configuration"/>
----

[cols=",",options="header"]
|===
|Attribute |Value
|*name* |`HTTP_Listener_Configuration`
|*host* |`localhost`
|*port* |`8081`
|*http://docname[doc:name]* |`HTTP Listener Configuration`
|===
....
------

==== HTTP Request Connector

[tabs]
------
[tab,title="Studio Visual Editor"]
....
. Select the HTTP Request Connector, and in the properties editor click image:add.png[add] to create a new Connector Configuration Element.
. Set up the *Host* and *Base Path*:
+
image::rest-api-examples-426f6.png[rest-api-examples-426f6]
+
[width="100%",cols="20a,80a",options="header",]
|===
|Parameter |Value
|*Name* |`HTTP_Request_Connector `
|*Host* |`query.yahooapis.com`
|*Port* |`80`
|*Base Path* |`v1/public.yql`
|===
+
This configuration sends requests to `query.yahooapis.com/v1/public.yql`
+
. Click *OK*.
. In the properties editor, set up the *Path* and *Method*:
+
image::rest-api-examples-4ec20.png[rest-api-examples-4ec20]
+
[cols=",",options="header"]
|===
|Parameter |Value
|*Display Name* |`HTTP `
|*Path* |`/`
|*Method* |`GET`
|===
+
. Click *Add Parameter* three times to add the parameters shown in the following tables. Accept the default type *query-param*. For the `value` field of each, write a mule expression that takes the value of the query parameters of the request that first reaches the HTTP Listener, and transforms the values into inbound properties for delivery to the HTTP Request Connector. 
+
image:yahoo+http+w+params.png[yahoo+http+w+params]
+
[cols=",",options="header"]
|===
|Parameter |Value
|*Type* |`query-param`
|*Name* |`q`
|*Value* |`#[message.inboundProperties.'http.query.params'.q]`
|===
+
[cols=",",options="header"]
|===
|Parameter |Value
|*Type* |`query-param`
|*Name* |`env`
|*Value* |`#[message.inboundProperties.'http.query.params'.env]`
|===
+
[cols=",",options="header"]
|===
|Parameter |Value
|*Type* |`query-param`
|*Name* |`format`
|*Value* |`#[message.inboundProperties.'http.query.params'.format]`
|===
+
Configured in this way, the API forwards the query params received by the HTTP listener to the Yahoo API.

. Select the *Advanced* tab on the left side panel of the connector, tick the checkbox labeled *Follow Redirects*
....
[tab,title="Standalone XML"]
....
Configure the HTTP connector as follows:

[source, xml, linenums]
----
<http:request config-ref="HTTP_Request_Configuration" path="/" method="GET" followRedirects="true" doc:name="HTTP">
            <http:request-builder>
                <http:query-param paramName="q" value="#[message.inboundProperties.'http.query.params'.q]"/>
                <http:query-param paramName="env" value="#[message.inboundProperties.'http.query.params'.env]"/>
                <http:query-param paramName="format" value="#[message.inboundProperties.'http.query.params'.format]"/>
            </http:request-builder>
        </http:request>
----

[cols=",",options="header"]
|===
|Attribute |Value
|*http://docname[doc:name]* |`HTTP`
|*config-ref* |`HTTP_Request_Configuration`
|*path* |`/ `
|*method* |`GET`
|`followRedirects` |`true`
|===

The series of child elements of the connector define three query parameters that take their values from inbound properties of the message. Enclosing the elements that define the query parameters is a `request-builder` element that is required for adding parameters to a request.

[cols=",",options="header"]
|===
|Parameter |Value
|*type* |`http:query-param`
|*paramName* |`q`
|*value* |`#[message.inboundProperties.'http.query.params'.q]`
|===

[cols=",",options="header"]
|===
|Parameter |Value
|*type* |`http:query-param`
|*paramName* |`env`
|*value* |`#[message.inboundProperties.'http.query.params'.env]`
|===

[cols=",",options="header",]
|===
|Parameter |Value
|*type* |`http:query-param`
|*paramName* |`format`
|*value* |`#[message.inboundProperties.'http.query.params'.format]`
|===

You now need to reference a *Connector Configuration*. The *config-ref* attribute in the connector references this connector configuration element. You must now create an element outside the flow that matches the referenced name.

----
<http:request-config name="HTTP_Request_Configuration" host="query.yahooapis.com" basePath="v1/public/yql" doc:name="HTTP Request Configuration"/>
----

[cols=",",options="header"]
|===
|Attribute |Value
|*name* |`HTTP_Request_Configuration`
|*host* |`query.yahooapis.com`
|*basePath* |`v1/public/yql`
|*http://docname[doc:name]* |`HTTP Request Configuration`
|===
....
------

==== Byte Array to String Transformer

Accept the following default values of this transformer.

[tabs]
------
[tab,title="Studio Visual Editor"]
....
*General Tab*

[width="100%",cols=",",options="header"]
|===
|Parameter |Value
|*Display Name* |`Byte Array to String`
|*Return Class* |`-`
|*Ignore Bad Input* |no
|*Encoding* |`-`
|*MIME Type* |`-`
|===
....
[tab,title="Standalone XML"]
....
*General Tab*

----
<byte-array-to-string-transformer doc:name="Byte Array to String"/>
----
....
------

==== Splitter

The splitter divides the incoming message into parts based on a user-defined expression. Configure the splitter as follows:

[tabs]
------
[tabs,title="Studio Visual Editor"]
....
*General Tab*
[width="100%",cols=",",options="header"]
|===
|Parameter |Value
|*Display Name* |`Byte Array to String`
|*Enable Correlation* |`IF_NOT_SET` (default)
|*Message Info Mapping* |`-`
|*Expression* |`#[xpath3('//results')]`
|===

The Advanced tab is set to its default values; no configuration is necessary.
....
[tab,title="Standalone XML"]
....
*General Tab*

----
<splitter expression="#[xpath3('//results')]" doc:name="Splitter"/>
----
....
------

==== Database Connector

In this procedure you set up and test a connection between the API and a Postgres database. First, ensure that you meet the prerequisites for working with the database.

*Prerequisites*

To successfully test the connection, you need to install and set up the database before configuring and testing the Database Connector.

. Install the correct link:/mule-user-guide/v/3.8/database-connector[database driver] for your database in your Studio application.
.  link:/mule-user-guide/v/3.8/database-connector#adding-the-database-driver-for-generic-db-configuration[Add the Postgres driver to the build path.]
. Start Postgres.
. Set up a database named `stock` with default user name `postgres` and password `postgres`.
. Create a table named mystock. For example, on the postgres command line enter the following query:
+
----
CREATE TABLE mystock (id SERIAL PRIMARY KEY, name varchar NOT NULL, date date, bookvalue money);
----

* Configure the Database Connector*

[tabs]
------
[tab,title="Studio Visual Editor"]
....

To configure the database connector in Studio:

. Click the *Database Connector*.
. In *Connector Configuration*, click image:add.png[add].
+
The *Choose Global Type* dialog appears.
+
image::rest-api-examples-deccf.png[rest-api-examples-deccf]
+
. Choose *Generic Database Configuration*, and click *OK*.
+
The *Generic Database Configuration* dialog appears.
+
. In *Name*, enter `Postgres`.
. In Database URL, enter the following URL, assuming you are using the default database password and user name for the stock database:
+
`jdbc:postgresql://localhost:5432/stock?password=postgres&user=postgres`
+
. Enter the driver class name:
+
`org.postgresql.Driver`
+
. Click *Test Connection*.
image::rest-api-examples-82a84.png[rest-api-examples-82a84]
+ If the test fails, check the prerequisites.
. Click *OK*.
. On the *General* tab of the properties editor, select  `Postgres` from the *Connector configuration* drop-down.
. In *Operation*, select `Insert` from the drop-down.
. In *Query*, select `Dynamic` from the *Type* drop-down.
. In the *Dynamic query* text box, enter the following query:
+
[source]
----
INSERT INTO mystock("name", "date", "bookvalue") VALUES(#[xpath3('//Name').text], #[xpath3('//LastTradeDate').text], #[xpath3('//BookValue').text]);
----
+
image::rest-api-examples-fb703.png[rest-api-examples-fb703]

....
[tab,title="Standalone XML"]
....
*Driver Configuration*
----
<db:generic-config name="Postgres" url="jdbc:postgresql://dbserver/stock" driverClassName="org.postgresql.Driver" doc:name="Generic Database Configuration"/>
----

*Database Configuration*

[source, xml, linenums]
----
<db:insert config-ref="Postgres" doc:name="Database">
   <db:dynamic-query><![CDATA[INSERT INTO mystock("name", "date", "bookvalue") VALUES(#[xpath3('//Name').text], #[xpath3('//LastTradeDate').text], #[xpath3('//BookValue').text]);]]> 
   </db:dynamic-query>
</db:insert>
----

....
------

=== Running This Example

. Run the example as a Mule application.
. Call the HTTP listener with your query.
+
Calling the listener triggers the flow. Use a Web browser or an HTTP client such as the link:http://curl.haxx.se/download.html[curl] command-line utility to call the HTTP listener on localhost port 8081.
+
This example shows retrieve a quote for Bank of America (ticker symbol BAC) by calling the HTTP listener using the following URL or curl command:
+
----
http://localhost?q=select%20*%20from%20yahoo.finance.quotes%20where%20symbol%20in%20
(%22BAC%22)%0A%09%09&env=http%3A%2F%2Fdatatables.org%2Falltables.env&format=XML
----
image:browser2.png[browser2]
+
----
curl 'http://localhost:8081?q=select%20*%20from%20yahoo.finance.quotes%20where
%20symbol%20in%20(%22BAC%22)%0A%09%09&env=http%3A%2F%2Fdatatables.org%2
Falltables.env&format=XML'
----

Check the Mule Console output to see the application's progress:

[source, code, linenums]
----
INFO  2016-04-08 15:42:33,531 [main] org.mule.module.launcher.MuleDeploymentService:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
+ Started app 'financeapi'                                 +
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
INFO  2016-04-08 15:43:09,155 [[financeapi].financeapiFlow1.stage1.02] org.mule.transport.service.DefaultTransportServiceDescriptor: Loading default outbound transformer: org.mule.transport.http.transformers.ObjectToHttpClientMethodRequest
INFO  2016-04-08 15:43:09,167 [[financeapi].financeapiFlow1.stage1.02] org.mule.transport.service.DefaultTransportServiceDescriptor: Loading default response transformer: org.mule.transport.http.transformers.MuleMessageToHttpResponse
INFO  2016-04-08 15:43:09,168 [[financeapi].financeapiFlow1.stage1.02] org.mule.transport.service.DefaultTransportServiceDescriptor: Loading default outbound transformer: org.mule.transport.http.transformers.ObjectToHttpClientMethodRequest
INFO  2016-04-08 15:43:09,168 [[financeapi].financeapiFlow1.stage1.02] org.mule.lifecycle.AbstractLifecycleManager: Initialising: 'connector.http.mule.default.dispatcher.1157186244'. Object is: HttpClientMessageDispatcher
INFO  2016-04-08 15:43:09,171 [[financeapi].financeapiFlow1.stage1.02] org.mule.lifecycle.AbstractLifecycleManager: Starting: 'connector.http.mule.default.dispatcher.1157186244'. Object is: HttpClientMessageDispatcher
INFO  2016-04-08 15:43:10,591 [[financeapi].financeapiFlow1.stage1.02] org.mule.routing.ExpressionSplitter: The expression does not evaluate to a type that can be split: org.dom4j.tree.DefaultElement
INFO  2016-04-08 15:43:10,597 [[financeapi].financeapiFlow1.stage1.02] org.mule.lifecycle.AbstractLifecycleManager: Initialising: 'Database.dispatcher.1108267618'. Object is: EEJdbcMessageDispatcher
INFO  2016-04-08 15:43:10,622 [[financeapi].financeapiFlow1.stage1.02] org.mule.lifecycle.AbstractLifecycleManager: Starting: 'Database.dispatcher.1108267618'. Object is: EEJdbcMessageDispatcher
INFO  2016-04-08 15:43:11,105 [[financeapi].financeapiFlow1.stage1.02] com.mulesoft.mule.transport.jdbc.sqlstrategy.UpdateSqlStatementStrategy: Executing SQL statement: 1 row(s) updated
----

The image below shows the data inserted in the database row as shown in pgAdmin III, Postgres's GUI interface.

image:pgadmin.png[pgadmin]

To try other queries, see the list of parameters on the link:https://developer.yahoo.com/yql/console/[Yahoo! Query Language page].

== See Also

* link:http://training.mulesoft.com[MuleSoft Training]
* link:https://www.mulesoft.com/webinars[MuleSoft Webinars]
* link:http://blogs.mulesoft.com[MuleSoft Blogs]
* link:http://forums.mulesoft.com[MuleSoft's Forums]
* link:https://www.mulesoft.com/support-and-services/mule-esb-support-license-subscription[MuleSoft Support]
* mailto:support@mulesoft.com[Contact MuleSoft]
